<html>
	<head>
		<link rel="stylesheet" href="style.css">
		<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
		<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jsonform/2.2.5/jsonform.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/@jsonforms/vue@3.3.0/lib/jsonforms-vue.esm.min.js "></script>

	</head>
	<body>

	<div id="app">
		
		<header>
				Mediacloud Buffet
		</header>
		<main>
			<div class="run-column">
				<sc_run v-for="r in all_runs"
					:id=r.id
					:name=r.name
					:params=r.parameters
					:start_state=r.state_name
				>
			    </sc_run>
			</div>
			<div class="detail-column">
				<sc_detail
								>

				</sc_detail>
			</div>
		</main>
		
	</div>
	<div class="padding">
		<div> 
			

		</div>
	</div>
	
	<script>
		const { createApp, ref } = Vue

		app = createApp({
			data(){
				return{
					all_runs:[]
				}
			},
			methods:{
				async getRuns(){
					const res = await fetch(
							"http://127.0.0.1:5000/all_runs"
													)
					runs = await res.json()
					this.all_runs = runs
				},
			},
			mounted(){
				this.getRuns()
			}

		})
		//Summary component- show a card for each run, with key info and state. 
		app.component("sc_run", {
			props:["id", "name", "params", "start_state"],
			template:`
				<div class="sc_run">
					{{ name }}
					{{ id }}
					{{ recipe_name }}
					{{ start_date }}
					{{ end_date }}
					<run_state :state=state> </run_state>
				</div>
			`,
			data(){
				return{
					recipe_name: this.params.data.NAME,
					query : this.params.data.QUERY,
					start_date :  this.params.data.START_DATE_STR,
					end_date: this.params.data.END_DATE_STR,
					state: this.start_state
				}
			},		
			methods:{
				async getRunStatus(){
					
					const res = await fetch(`http://127.0.0.1:5000/run/${this.id}`)
					final_res = await res.json()
					this.state = final_res.state_name
					console.log(this.state)
					if(this.isOngoing()){
						setTimeout(this.getRunStatus, 10000)
					}
				},
				isOngoing(){
					return ["Running", "Scheduled", "Pending"].includes(this.state)
				}
			},
			mounted(){
				if(this.isOngoing()){
					setTimeout(this.getRunStatus, 10000)
				}
			}
		})

		//Reusable state component, which manages updating state on its own. 
		app.component("run_state", {
			props:["state"],
			template:`
				<div class="run_state">
					{{ state }}
				</div>
			`,
		})

		//still not completely sure what the signature is here- it's probably a run id, but run id can be none...
		app.component("sc_detail", {
			template:`
			<div>
				{{ title }}
				{{ menu }}
				<sc-form
					:data="data"
					:renderers="renderers"
					:schema="schema"
					:uischema="uischema"
					@change="onChange"				
				/>
				
			</div>
			`,
			data(){
				return{
					menu: null,
					title: "",
					fields:[]
				}
			},
			methods:{
				async getSCSchema(){
					const res = await fetch(`http://127.0.0.1:5000/menu`)
					final_res = await res.json()
					this.menu = final_res
					this.title = this.menu.title
					for( let field of Object.values(final_res.properties)){
						console.log(field)
						this.fields.push(field)
					}
					console.log(this.fields)
				}

			},

			mounted(){
				this.getSCSchema()
				console.log(this.menu)
			}

		})

		app.component("sc-form", {
			components:{
				JSONForm,
			},
			data() {
			    return {
			    	 // freeze renderers for performance gains
			    	renderers: Object.freeze(this.renderers),
			    	data: {
			        	number: 5,
			      	},
			     	schema: {
			        	properties: {
			          		number: {
			            		type: 'number',
			          		},
			       		},
			      	},
			      	uischema: {
			        	type: 'VerticalLayout',
			        	elements: [
			          		{
			        	    type: 'Control',
			            	scope: '#/properties/number',
			          		},
			        	],
			      	},
			    }
			},
			methods: {
			   	onChange(event) {
			      this.data = event.data;
			    },
			},
		})

		app.mount("#app")

	</script>
	</body>
</html>
